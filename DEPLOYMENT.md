# LineageForge Deployment Guide

## Railway Deployment

### Prerequisites
- Railway account
- Railway CLI installed (optional)

### Environment Variables

Set these in Railway dashboard:

```bash
# Database (provided by Railway Postgres plugin)
DATABASE_URL=<auto-generated>

# Redis (provided by Railway Redis plugin)
REDIS_URL=<auto-generated>

# Application
APP_NAME=LineageForge
APP_VERSION=0.1.0
DEBUG=false

# Identity Resolution
IDENTITY_MERGE_THRESHOLD=0.75
IDENTITY_MAX_CANDIDATES=100

# Expansion
EXPANSION_MAX_DEPTH=3
EXPANSION_MAX_NODES=1000

# WikiTree
WIKITREE_API_BASE=https://api.wikitree.com/api.php
WIKITREE_RATE_LIMIT=0.5

# Worker
WORKER_TIMEOUT=3600
```

### Services

Railway requires **three services**:

1. **Database** (Postgres plugin)
   - Add Postgres plugin from Railway marketplace
   - Database URL will be auto-generated

2. **Redis** (Redis plugin)
   - Add Redis plugin from Railway marketplace
   - Redis URL will be auto-generated

3. **Web Service** (from this repo)
   - Connect your GitHub repository
   - Railway will detect Dockerfile automatically
   - Set start command: `uvicorn app.main:app --host 0.0.0.0 --port $PORT`

4. **Worker Service** (from this repo, separate deployment)
   - Create another service from same repo
   - Set start command: `python -m app.worker.worker`
   - Share same DATABASE_URL and REDIS_URL

### Deployment Steps

1. **Create Railway Project**
   ```bash
   railway login
   railway init
   ```

2. **Add Postgres Plugin**
   - Go to Railway dashboard
   - Click "New" → "Database" → "Add PostgreSQL"
   - Copy DATABASE_URL to environment variables

3. **Add Redis Plugin**
   - Click "New" → "Database" → "Add Redis"
   - Copy REDIS_URL to environment variables

4. **Deploy Web Service**
   - Click "New" → "GitHub Repo"
   - Select your LineageForge repository
   - Railway detects Dockerfile automatically
   - Add environment variables
   - Deploy

5. **Deploy Worker Service**
   - Click "New" → "GitHub Repo" (same repo)
   - Override start command: `python -m app.worker.worker`
   - Use same DATABASE_URL and REDIS_URL
   - Deploy

6. **Run Migrations**
   - In Railway dashboard, open web service shell
   - Run: `alembic upgrade head`

### Health Check

Once deployed, test the deployment:

```bash
curl https://your-app.railway.app/health
```

Expected response:
```json
{
  "status": "healthy",
  "version": "0.1.0"
}
```

---

## Local Development

### Using Docker Compose

1. **Start all services**
   ```bash
   docker-compose up -d
   ```

2. **Run migrations**
   ```bash
   docker-compose exec web alembic upgrade head
   ```

3. **Access application**
   - Web: http://localhost:8000
   - API docs: http://localhost:8000/docs

4. **Stop services**
   ```bash
   docker-compose down
   ```

### Manual Setup

1. **Install dependencies**
   ```bash
   pip install -r requirements.txt
   ```

2. **Set environment variables**
   ```bash
   export DATABASE_URL=postgresql://postgres:postgres@localhost:5432/lineageforge
   export REDIS_URL=redis://localhost:6379/0
   ```

3. **Run migrations**
   ```bash
   alembic upgrade head
   ```

4. **Start web service**
   ```bash
   uvicorn app.main:app --reload
   ```

5. **Start worker (separate terminal)**
   ```bash
   python -m app.worker.worker
   ```

---

## Verification

After deployment, verify all components:

1. **Web service**: `GET /health`
2. **Database**: `GET /api/person` (should return empty list)
3. **Import**: Upload a GEDCOM file via `POST /api/import/gedcom`
4. **Worker**: Check job status via `GET /api/jobs/{job_id}`

---

## Troubleshooting

### Database Connection Issues
- Verify DATABASE_URL is set correctly
- Ensure Postgres service is running
- Check network connectivity between services

### Worker Not Processing Jobs
- Verify REDIS_URL is set correctly
- Ensure Redis service is running
- Check worker logs for errors

### Import Failures
- Check GEDCOM file format
- Verify file upload size limits
- Review job error messages in `/api/jobs/{job_id}`

---

## Scaling

Railway supports automatic scaling:

- **Web service**: Scales based on traffic
- **Worker service**: Add more worker instances for parallel job processing
- **Database**: Upgrade Postgres plan for larger datasets

For production workloads:
- Enable connection pooling
- Add caching layer (Redis)
- Set up monitoring (Railway provides built-in metrics)
